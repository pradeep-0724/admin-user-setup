<form [formGroup]="addCreditNote">
    <div class="right-section__header align-items-center justify-content-between">
        <h1 class="heading" *ngIf="!creditNoteId">Add Credit Note</h1>
        <h1 class="heading" *ngIf="creditNoteId">Edit Credit Note</h1>
        <button class="gb-video-play float-right" (click)="openGothrough()">
            <i class="bi bi-play-circle-fill"></i>
        </button>
    </div>
    <div class="alert-msg" *ngIf="apiError">
        <span class="icon-wrap"></span>
        <p class="message-cont">{{ apiError }}</p>
    </div>
    <div class="error-msg-list" *ngIf="globalFormErrorList.length > 0">
        <p class="message-head">{{ errorHeaderMessage }}</p>
        <span class="icon-wrap"></span>
        <ul *ngFor="let error of globalFormErrorList">
            <li class="message-cont">{{ error }}</li>
        </ul>
    </div>
    <div class="form-layout shadow-inset-top-lg form-layout--pd">
        <div class="form-layout__card active">
            <div class="form-body">
                <div class="row tabIndexActiveFields">
                    <div *ngIf="creditNoteId" class="col-lg-3 col-sm-6">
                        <div class="input-wrap disabled">
                            <label for="" class="input--required">Customer </label>
                            <div class="input--bd">{{ initialValues.party.label }}</div>
                            <span *ngIf="gstin" class="font-small-blue"> {{terminology.tax_no_type}}: {{gstin}} </span>
                        </div>
                    </div>

                    <div *ngIf="!creditNoteId" class="col-lg-3 col-sm-6">
                        <div class="input-wrap error" [ngClass]="addErrorClass(addCreditNote.controls.party)">
                            <label for="" class="input--required">Customer </label>
                            <material-dropdown [searchable]="true" [addable]="true" class="dropDownWidth"
                                [selectedOption]="initialValues.party" [party]="true"
                                (addPartyPopup)="openAddPartyModal($event)"
                                (addValueToList)="addValueToPartyPopup($event)" [params]="partyNamePopup"
                                [maxLength]="255">
                                <select #customSelect formControlName="party" class="no-style select--modify"
                                    (change)="onPartySelected($event.target.value)">
                                    <option *ngFor="let party of partyList" value="{{ party.id }}">
                                        {{ party.party_display_name }}
                                    </option>
                                </select>
                            </material-dropdown>
                            <span *ngIf="gstin" class="font-small-blue"> {{terminology.tax_no_type}}: {{gstin}} </span>
                            <app-error [controlName]="addCreditNote.controls.party"></app-error>
                        </div>
                    </div>


                    <div class="col-lg-3 col-sm-6">
                        <div class="input-wrap">
                            <label for="">Employee In Charge</label>
                            <material-dropdown [searchable]="true" [addable]="false" [addBlank]="true"
                                class="dropDownWidth" [selectedOption]="initialValues.employee">
                                <select #customSelect formControlName="employee" class="no-style select--modify">
                                    <option *ngFor="let employee of employeeList" value="{{ employee.id }}">
                                        {{ employee.emp_name_id }}
                                    </option>
                                </select>
                            </material-dropdown>
                            <span class="border-anim"></span>
                        </div>
                    </div>
                    <div *ngIf="creditNoteId" class="col-lg-3 col-sm-6">
                        <div class="input-wrap disabled">
                            <label for="" class="input--required">Credit Note Number</label>
                            <div class="input--bd">{{ addCreditNote.controls.credit_note_number.value }}</div>
                        </div>
                    </div>

                    <div *ngIf="!creditNoteId" class="col-lg-3 col-sm-6">
                        <div class="input-wrap error"
                            [ngClass]="addErrorClass(addCreditNote.controls.credit_note_number)">
                            <label for="" class="input--required">Credit Note Number</label>
                            <input type="text" class="no-style input--bd"
                                [readonly]="{disableInput: creditNoteId !=='null'}" placeholder="Enter Number" value=""
                                formControlName="credit_note_number">
                            <span class="border-anim"></span>
                            <app-error [controlName]="addCreditNote.controls.credit_note_number"></app-error>
                        </div>
                    </div>

                    <div class="col-lg-3 col-sm-6">
                        <div class="input-wrap error error--type-1"
                            [ngClass]="addErrorClass(addCreditNote.controls.credit_note_date)">
                            <label for="" class="input--required">Credit Note Date</label>
                            <mat-form-field>
                                <input matInput [matDatepicker]="picker1" (focus)="picker1.open()"
                                    formControlName="credit_note_date" placeholder="DD/MM/YYYY">
                                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                                <mat-datepicker #picker1></mat-datepicker>
                            </mat-form-field>
                            <app-error [controlName]="addCreditNote.controls.credit_note_date"></app-error>
                        </div>
                    </div>

                    <div class="col-lg-3 col-sm-6">
                        <div class="input-wrap">
                            <label for="">Reference Number</label>
                            <input type="text" class="no-style input--bd" placeholder="Enter number" value=""
                                formControlName="reference_number">
                            <span class="border-anim"></span>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                        <div class="input-wrap">
                            <label for="">Reason</label>
                            <material-dropdown [searchable]="true" [addBlank]="true"
                                [selectedOption]="initialValues.reason">
                                <select #customSelect formControlName="reason">
                                    <option *ngFor="let reason of reasonList" value="{{ reason.id }}">{{ reason.label }}
                                    </option>
                                </select>
                            </material-dropdown>
                            <span class="border-anim"></span>
                        </div>
                    </div>


                </div>
                <div *ngIf="debitNoteData?.address && debitNoteData?.address.length" class="col-lg-12">
                    <app-address [address]="debitNoteData?.address" (emitAddress)="getAddress($event)"></app-address>
                </div>
                <div class="form-layout__card mt-3">
                    <div class="form-layout__header">
                        <h2 class="sub-heading">Invoice Detail</h2>
                        <span class="collapse-line"></span>
                    </div>
                    <div class="form-body">
                        <div class="row tabIndexActiveFields">
                            <div class="col-lg-3 col-sm-6">
                                <div class="input-wrap error" [ngClass]="addErrorClass(addCreditNote.controls.invoice)">
                                    <label for="" class="input--required">Invoice Number</label>
                                    <material-dropdown [searchable]="true" [addable]="false" class="dropDownWidth"
                                        [selectedOption]="initialValues.invoice">
                                        <select #customSelect formControlName="invoice" class="no-style select--modify"
                                            (change)="populate_invoice_date($event.target.value)">
                                            <option *ngFor="let term of invoiceList" value="{{term.id}}">
                                                {{ term.invoice_number }}
                                            </option>
                                        </select>
                                    </material-dropdown>
                                    <app-error [controlName]="addCreditNote.controls.invoice"></app-error>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-wrap error error--type-1 disabled"
                                    [ngClass]="addErrorClass(addCreditNote.controls.invoice_date)">
                                    <label for="" class="">Invoice Date</label>
                                    <mat-form-field>
                                        <input matInput [matDatepicker]="picker3" (focus)="picker3.open()"
                                            formControlName="invoice_date" placeholder="DD/MM/YYYY">
                                        <mat-datepicker-toggle matSuffix [for]="picker3"></mat-datepicker-toggle>
                                        <mat-datepicker #picker3></mat-datepicker>
                                    </mat-form-field>
                                    <span class="border-anim"></span>
                                    <app-error [controlName]="addCreditNote.controls.invoice_date"></app-error>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="form-layout__card mt-3 mb-2">
                    <div class="form-layout__header">
                        <h2 class="sub-heading">Item Details</h2>
                        <span class="collapse-line"></span>
                    </div>
                    <div class="mg-top-30">
                        <div
                            class="table-wrapper table-wrapper--type1 table-wrapper--type2  table--bd table--nobg overflow-unset">
                            <table class="table-container">
                                <thead>
                                    <tr class="desktop_th">
                                        <th width=15%>Additional Charge</th>
                                        <th width=13%>Total units</th>
                                        <th width=7%>Unit</th>
                                        <th width=9%>Rate per unit ({{ currency_type?.symbol}})</th>
                                        <th width=9%>Amount ({{ currency_type?.symbol}})</th>
                                        <th width=9% [ngClass]="{'hiddenContent':!isTax}">Tax</th>
                                        <th width=11%>Total ({{ currency_type?.symbol}})</th>
                                        <th width=9%></th>
                                    </tr>
                                </thead>
                                <tbody formArrayName="others">
                                    <tr class="mobile-flex tabIndexActive"
                                        *ngFor="let otherItem of addCreditNote.controls.others.controls; let i = index;"
                                        [formGroupName]="i">
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Item</span>
                                            <div class="select-wrap">
                                                <material-dropdown [addable]="true" [maxLength]="36"
                                                    [addErrorClass]="addErrorClass(addCreditNote.controls.others.controls[i].controls.item)"
                                                    [addNewOptions]="true" [selectedOption]="initialValues.item[i]"
                                                    (addNewOption)="addNewExpenseType($event,otherItem,i)">
                                                    <select #customSelect formControlName="item"
                                                        class="no-style select--modify"
                                                        (change)="onMaterialSelected($event, otherItem,i);">
                                                        <option *ngFor="let option of staticOptions.materialList"
                                                            value="{{ option.name?.id }}">
                                                            {{ option.name?.name }}
                                                        </option>
                                                    </select>
                                                </material-dropdown>
                                            </div>
                                        </td>
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Total units</span>
                                            <div class="input-wrap"
                                                [ngClass]="addErrorClass(addCreditNote.controls['others'].controls[i].controls.quantity)">
                                                <input positiveThreeDigitDecimalNumber class="error-box" type="text"
                                                    placeholder="Eg.: 1234567" formControlName="quantity"
                                                    (change)="calculateItemOthersAmount(i)">
                                            </div>
                                        </td>
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Unit</span>
                                            <div class="select-wrap">
                                                <material-dropdown [searchable]="true" [addable]="false"
                                                    [addBlank]="true" class="dropDownWidth"
                                                    [selectedOption]="initialValues.units[i]"
                                                    [addErrorClass]="addErrorClass(addCreditNote.controls.others.controls[i].controls.units)">
                                                    <select #customSelect formControlName="units"
                                                        class="no-style select--modify">
                                                        <option *ngFor="let option of staticOptions.itemUnits"
                                                            value="{{ option.id }}">
                                                            {{ option.label }}
                                                        </option>
                                                    </select>
                                                </material-dropdown>
                                            </div>
                                        </td>
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Rate per unit ({{
                                                currency_type?.symbol}})</span>
                                            <div class="input-wrap"
                                                [ngClass]="addErrorClass(addCreditNote.controls['others'].controls[i].controls.unit_cost)">
                                                <input positiveThreeDigitDecimalNumber class="error-box" type="text"
                                                    placeholder="1000" formControlName="unit_cost"
                                                    (change)="calculateItemOthersAmount(i)">
                                            </div>
                                        </td>
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Amount</span>
                                            <div class="input-wrap"
                                                [ngClass]="addErrorClass(addCreditNote.controls['others'].controls[i].controls.amount)">
                                                <input type="number" class="error-box" placeholder="1000" readonly
                                                    formControlName="amount" (change)="calculateItemOther(i)">
                                            </div>
                                        </td>


                                        <td [ngClass]="{'hiddenContent':!isTax}" class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Tax</span>
                                            <div [ngClass]="{disable: !companyRegistered}">
                                                <div class="error"
                                                    [ngClass]="addErrorClass(addCreditNote.controls['others'].controls[i].controls.tax)">
                                                    <material-dropdown [searchable]="true" [addable]="false"
                                                        class="dropDownWidth" [selectedOption]="initialValues.tax[i]"
                                                        [disabled]="!companyRegistered">
                                                        <select #customSelect formControlName="tax"
                                                            class="no-style select--modify"
                                                            (change)="calculationsChanged()">
                                                            <option *ngFor="let option of taxOptions"
                                                                value="{{ option.id }}">
                                                                {{ option.label }}
                                                            </option>
                                                        </select>
                                                    </material-dropdown>
                                                    <app-error
                                                        [controlName]="addCreditNote.controls['others'].controls[i].controls.tax"></app-error>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="max-wd120">
                                            <span class="th_h5_mobile fw-semibold">Total ({{
                                                currency_type?.symbol}})</span>

                                            <div class="input-wrap disabled">
                                                <input type="number" placeholder="1000" class="error-box"
                                                    formControlName="total" (change)="calculationsChanged()"
                                                    [attr.disabled]="true">
                                            </div>
                                        </td>
                                        <td class="max-wd120 mobile-width-100">
                                            <button class="material-icons clear p-0"
                                                (click)="resetOther(otherItem, i)">remove_circle_outline</button>
                                            <button class="material-icons delete p-0" (click)="removeOtherItem(i)"
                                                *ngIf="addCreditNote.controls.others.controls.length !== 1">add_circle_outline</button>
                                            <button class="material-icons add p-0"
                                                (click)="addMoreOtherItem()">add_circle_outline</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer-actions mg-top-20 tabIndexActive">
                            <button class="clear-item p-0" (click)="clearAllOtherItems()">Remove all</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mx-0 def-color">
        <div class="col-lg-4 px-0">
            <div class="gb-fake-tab-wrapper">
                <span>Terms and Conditions</span>
            </div>
            <div class="p-4 pb-0">
                <div class="input-wrap clearfix approval-input">
                    <label>Terms and Conditions</label>
                    <material-dropdown [searchable]="true"
                        [selectedOption]="initialValues.termsAndCondition" [addable]="false"
                        class="dropDownWidth" [addBlank]="true">
                        <select #customSelect formControlName="terms_and_condition"
                            class="no-style select--modify">
                            <option *ngFor="let option of tersmAndConditions " value="{{option.id}}">
                                {{option.name}}
                            </option>
                        </select>
                    </material-dropdown>
                </div>
                <div class="input-wrap clearfix approval-input">
                    <label for="" class="">Signature</label>
                    <div>
                        <material-dropdown [selectedOption]="initialValues.digitalSignature">
                            <select #customSelect class="no-style select--modify"
                                formControlName="signature">
                                <option *ngFor="let option of digitalSignature " value="{{option.id}}">
                                    {{option.name}}
                                </option>
                            </select>
                        </material-dropdown>
                    </div>
                </div>
                <div class="input-wrap clearfix approval-input">
                    <label for="" class="">Remarks (For Internal Use)</label>
                    <input type="text" class="no-style input--bd" placeholder="Comments" value=""
                        formControlName="remarks">
                </div>
                <div class="input-wrap clearfix approval-input">
                    <label for="" class="">Narration</label>
                    <div>
                        <textarea class="error-box w-100 p-2" formControlName="narrations" min="2" rows="6"
                            placeholder="Enter your business narration"></textarea>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-lg-8 px-0 balance-block">
            <div class="gb-fake-tab-wrapper">
                <span>Credit Total</span>
            </div>
            <div class="p-4 pb-0">

                <div class="d-flex fw-semibold justify-content-between align-items-center mb-3">
                    <span class=" me-5">Subtotal</span>
                    <span>{{ currency_type?.symbol}} {{ totals.subtotal|numberFormat }}</span>
                </div>
                <div [ngClass]="{'hiddenContent':!isTax}">
                    <ng-container *ngFor="let percentageTotal of totals.taxes;">
                        <div class="d-flex justify-content-end mb-1">
                            <div *ngIf="percentageTotal.total && percentageTotal.taxAmount>0" class="text-end gst-left">Include
                                {{terminology.tax_type}} &#64; {{ percentageTotal.value }}% on <span>{{
                                    percentageTotal.total |numberFormat}}</span> : &nbsp; &nbsp; </div>
                            <div *ngIf="percentageTotal.total && percentageTotal.taxAmount>0 " class="px-0  fw-semibold text-end gst-right">
                                {{ currency_type?.symbol}} {{ percentageTotal.taxAmount|numberFormat }}</div>
                        </div>
                    </ng-container>
                </div>
                <!-- <div class="d-flex fw-semibold justify-content-between align-items-center mb-3">
                    <div class="d-flex justify-content-space-around align-items-center gst-table-wrapper">
                        <span class="fw-bold p-0">Discount after Tax </span>
                        <div class="select-wrap dropdown mx-2">
                            <select name="" class="no-style select--modify"
                                formControlName="adjustment_choice" (change)="calculationsChanged();">
                                <option value="0" selected>%</option>
                                <option value="1">{{ currency_type?.symbol}}</option>
                            </select>
                        </div>
                        <div class="input"
                            [ngClass]="addErrorClass(addCreditNote.controls.adjustment_amount)">
                            <input twoDigitDecimalNumber type="text" class="error-box" placeholder=""
                                formControlName="adjustment_amount" (change)="calculationsChanged()">
                        </div>
                    </div>
                    <div class="px-0  text-end gst-right"> {{ currency_type?.symbol}} {{ totals.adjustment
                        }}</div>
                </div> -->
                <div class="d-flex fw-semibold justify-content-between align-items-center mb-3">
                    <mat-checkbox [disableRipple]="true" color="primary" (change)="onRoundOffEvent($event)"
                        formControlName="is_roundoff">Round Off</mat-checkbox>
                    <span>{{ currency_type?.symbol}} {{ totals.roundOffAmount |numberFormat}}</span>
                </div>



            </div>
            <div class="d-flex fw-semibold justify-content-between align-items-center py-3 px-4 border-top">
                <span class=" me-5 fs-5"> Total</span>
                <span class="  fs-5">{{ currency_type?.symbol}} {{ totals.total |numberFormat}}</span>
            </div>
        </div>
    </div>




    <div class="form-layout__card  tabIndexActive px-4 pt-4">
        <file-uploader (onFileUploaded)="fileUploader($event)" (onFileDeleted)="fileDeleted($event)"
            [multiple]="true" [accept]="'capture=camera, image/jpeg,image/x-jpg,image/png, application/pdf'"
            [showFileName]="false" [patchFileUrls]="patchFileUrls">
        </file-uploader>
    </div>

</form>
<div class="footer-bg p-2 px-4 custom-footer-bg d-flex justify-content-end">

    <button class="btn btn--sm me-2" [routerLink]="[preFixUrl+'/income/credit-note/list']">Cancel</button>
    <button class=" w-auto ws-nowrap btn btn--primary btn--default btn-mg-left btn--dropdown btn--save-credit"
        (click)="saveButton = !saveButton">{{creditNoteId?'Update':'Save'}} Credit Note
        <i class="material-icons">arrow_drop_down</i>
        <div class="more-actions__menu" id="custom-dropdown-top" [ngClass]="{'show': saveButton}">
            <button class="more-actions__item w-100 text-start" type="button" (click)="submitForm()">Save &
                Submit</button>
            <button class="more-actions__item w-100 text-start" *ngIf="debitNoteData?.status?.label == 'Draft'"
                type="button" (click)="saveAsDraft()">Save as
                Draft</button>
            <button *ngIf="!creditNoteId" class="more-actions__item w-100 text-start" type="button"
                (click)="saveAsDraft()">Save as
                Draft</button>
        </div>
    </button>

</div>
<app-add-party-popup [popDetail]="showAddPartyPopup" (closeModal)="closePartyPopup()"
    (partyAdded)="addPartyToOption($event)"></app-add-party-popup>
<app-go-through [goThroughDetais]="goThroughDetais"></app-go-through>