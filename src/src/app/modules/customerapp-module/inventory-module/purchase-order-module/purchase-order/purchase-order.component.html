<div class="right-section__header">
    <h1 class="heading" *ngIf="editId=='null'">Add Purchase Order</h1>
    <h1 class="heading" *ngIf="editId!='null'" >Edit Purchase Order</h1>
  </div>
<form [formGroup]="purchaseOrderForm" (keydown.enter)="$event.preventDefault();">
  <div class="form-body form-layout form-layout--pd no-br-tl no-br-tr">
      <div class="alert-msg" *ngIf="apiError">
          <span class="icon-wrap"></span>
          <p class="message-cont">{{ apiError }}</p>
      </div><br>

      <div class="error-msg-list" *ngIf="globalFormErrorList.length > 0">
          <p class="message-head">{{ errorHeaderMessage }}</p>
          <span class="icon-wrap"></span>
          <ul *ngFor="let error of globalFormErrorList">
              <li class="message-cont">{{ error }}</li>
          </ul>
      </div><br>
      <div class="row">
        <div class="col-lg-3 col-sm-6">
          <div class="input-wrap error" [ngClass]="addErrorClass(purchaseOrderForm.controls.vendor)">
              <label for="" class="input--required   position-relative">Vendor Name <span *ngIf="isTdsDecleration" class="blueTag">TDS Declaration Received</span></label>
              <material-dropdown [searchable]="true"
                                 [addable]="true"
                                 class="dropDownWidth"
                                 [selectedOption]="initialValues.vendor"
                                 [party]="true" (addPartyPopup)="openAddPartyModal($event)"
                                 (addValueToList)="addValueToPartyPopup($event)"
                                 [params]="partyNamePopup">
                  <select #customSelect formControlName="vendor" class="no-style select--modify" (change)="onvendorSelected($event)"  (change)="stopLoaderClasstoBody()">
                      <option *ngFor="let vendor of vendorList" value="{{ vendor.id }}">
                          {{ vendor.party_display_name }}</option>
                  </select>
              </material-dropdown>
              <span *ngIf="gstin" class="font-small-blue"> GSTIN: {{gstin}} </span>
              <app-error [controlName]="purchaseOrderForm.controls.vendor"></app-error>
          </div>
        </div>
          <div class="col-lg-3 col-sm-6">
            <div class="input-wrap error" [ngClass]="addErrorClass(purchaseOrderForm.controls.po_number)">
                <label for="" class="input--required">PO Number</label>
                <input type="text" class="no-style input--bd" placeholder="Eg.:1234567" value="" formControlName="po_number">
                <span class="border-anim"></span>
                <app-error [controlName]="purchaseOrderForm.controls.po_number"></app-error>
            </div>
        </div>
          <div class="col-lg-3 col-sm-6">
              <div class="input-wrap" [ngClass]="addErrorClass(purchaseOrderForm.controls.po_date)">
                  <label for="" class="input--required">PO Date</label>
                  <mat-form-field>
                      <input matInput [matDatepicker]="po_date" (focus)="po_date.open()" formControlName="po_date" placeholder="DD/MM/YYYY">
                      <mat-datepicker-toggle matSuffix [for]="po_date"></mat-datepicker-toggle>
                      <mat-datepicker #po_date></mat-datepicker>
                  </mat-form-field>
                  <app-error [controlName]="purchaseOrderForm.controls.po_date"></app-error>
              </div>
          </div>
          <div class="col-lg-3 col-sm-6">
            <div class="input-wrap" [ngClass]="addErrorClass(purchaseOrderForm.controls.expected_delivery_date)">
                <label for="" >Expected Delivery Date</label>
                <mat-form-field>
                    <input matInput [matDatepicker]="expected_delivery_date" (focus)="expected_delivery_date.open()" formControlName="expected_delivery_date" placeholder="DD/MM/YYYY">
                    <mat-datepicker-toggle matSuffix [for]="expected_delivery_date"></mat-datepicker-toggle>
                    <mat-datepicker #expected_delivery_date></mat-datepicker>
                </mat-form-field>
                <app-error [controlName]="purchaseOrderForm.controls.expected_delivery_date"></app-error>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6">
          <div class="input-wrap">
              <label for="" class="input">Payment Terms</label>
              <material-dropdown [searchable]="true" [addable]="false" class="dropDownWidth" [selectedOption]="initialValues.payementTerm">
                  <select #customSelect formControlName="payment_term" class="no-style select--modify">
                  <option *ngFor="let payment of paymentTermList" value="{{payment?.id}}">
                      {{ payment.label}}
                  </option>
              </select>
              </material-dropdown>
          </div>
        </div>
          <div class="col-lg-3 col-sm-6">
              <div class="input-wrap">
                  <label for="" class="input">Employee Name</label>
                  <material-dropdown [searchable]="true" [addable]="false" class="dropDownWidth" [selectedOption]="initialValues.employee">
                      <select #customSelect formControlName="employee" class="no-style select--modify">
                      <option *ngFor="let employee of employeeList" value="{{employee?.id}}">
                          {{ employee?.first_name }} {{ employee?.last_name }}
                      </option>
                  </select>
                  </material-dropdown>
              </div>
          </div>
      </div>
      <!-- test -->
      <div class="form-layout__card mg-top-30">
          <div class="form-layout__header">
              <h2 class="sub-heading">New Spare</h2>
              <span class="collapse-line"></span>
          </div>
          <div class="">
              <div class="table-wrapper table-wrapper--type1 table-wrapper--type2  table--bd table--nobg dropdownOverlay">
                  <table class="table-container item-table">
                      <thead>
                          <tr>
                              <th  width="18%" >Item Name</th>
                              <th  width="18%">Quantity</th>
                              <th  width="18%">Unit</th>
                              <th  width="18%">Unit Cost   ({{ currency_type?.symbol}})</th>
                              <th  width="18%">Estimated Total   ({{ currency_type?.symbol}})</th>
                              <th  width="10%" ></th>
                          </tr>
                      </thead>
                      <tbody formArrayName="spares">
                        <ng-container *ngFor="let spareItem of purchaseOrderForm.controls.spares['controls']; let i = index;" [formGroupName]="i">
                          <tr>
                                  <td>
                                      <div>
                                        <material-dropdown [addable]="true" class="dropDownWidth" [item]="true" [maxLength]="36"
                                        [addErrorClass]="addErrorClass(spareItem.controls.item)"
                                        class="dropDownWidth" (addItemPopup)="openAddExpenseItemModal($event, i)"
                                        (addValueToList)="addParamsToNewSpareItem($event)"
                                        [params]="newSparesItemParams" [selectedOption]="initialValues?.item[i]"
                                          >
                                              <select #customSelect formControlName="item"
                                                  class="no-style select--modify"  (change)="onMaterialSelected(spareItem,i)"
                                                  >
                                                  <option *ngFor="let option of materialList"
                                                      value="{{ option.id }}">
                                                      {{ option.name }}
                                                  </option>
                                              </select>
                                            </material-dropdown>
                                      </div>
                                  </td>
                                  <td class="w-150">
                                    <div class="input-wrap w-initial" [ngClass]="addErrorClass(spareItem.controls.quantity)">
                                          <input positiveThreeDigitDecimalNumber type="text" placeholder="Eg.: 1234567"
                                          formControlName="quantity" class="error-box" (change)="calculateItemAmount(i)">
                                    </div>
                                  </td>
                                  <td>
                                          <material-dropdown [addable]="false" class="dropDownWidth" [selectedOption]="initialValues.units[i]"
                                          class="dropDownWidth"   [addErrorClass]="addErrorClass(spareItem.controls.unit)">
                                                <select #customSelect formControlName="unit"
                                                    class="no-style select--modify"
                                                    >
                                                    <option *ngFor="let option of staticOptions.itemUnits"
                                                        value="{{ option.id }}">
                                                        {{ option.label }}
                                                    </option>
                                                </select>
                                              </material-dropdown>
                                          </td>
                                  <td class="input-wrap w-initial" [ngClass]="addErrorClass(spareItem.controls.rate)">
                                      <input positiveThreeDigitDecimalNumber type="text" class="error-box" placeholder="1000" formControlName="rate" (change)="calculateItemAmount(i)">
                                  </td>

                                  <td>
                                      <div class="input-wrap" [ngClass]="addErrorClass(spareItem.controls.total)">
                                          <input positiveThreeDigitDecimalNumber type="text" class="error-box" placeholder="1000"
                                              formControlName="total"
                                             readonly >
                                      </div>
                                  </td>
                                      <td class="text-center">
                                      <span class="material-icons delete"
                                      (click)="removeSpareItem(i)" *ngIf="purchaseOrderForm.controls.spares[ 'length'] !==1">add_circle_outline</span>
                                      <span class="material-icons add" *ngIf="purchaseOrderForm.controls.spares['controls'].length -1== i"
                                      (click)="addMoreSpareItem()">add_circle_outline</span>
                                  </td>
                              </tr>

                        </ng-container>
                      </tbody>
                  </table>
              </div>
              <div class="table-footer-actions mg-top-20">
                  <a class="clear-item" (click)="removeSpareAll()">
                 Clear all</a>
              </div>
          </div>
      </div>
      <div class="form-layout__card mg-top-30">
        <div class="form-layout__header">
            <h2 class="sub-heading">New Tyre</h2>
            <span class="collapse-line"></span>
        </div>
        <div class="">
            <div class="table-wrapper table-wrapper--type1 table-wrapper--type2  table--bd table--nobg dropdownOverlay">
                <table class="table-container ">
                    <thead>
                        <tr>
                            <th width="15%">Make</th>
                            <th width="15%" >Model</th>
                            <th width="15%" >Type</th>
                            <th width="15%" >Quantity</th>
                            <th width="15%" >Unit Cost  ({{ currency_type?.symbol}})</th>
                            <th width="15%" >Estimated Total  ({{ currency_type?.symbol}})</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody formArrayName="tyres">
                      <ng-container *ngFor="let tyreItem of purchaseOrderForm.controls.tyres['controls']; let ii = index;" [formGroupName]="ii">
                        <tr>
                                <td class="w-150">
                                    <div class="select-wrap">
                                          <material-dropdown [searchable]="true" [addable]="true" class="dropDownWidth"
                                          [postApiUrl]="manufacturerApi"
                                          [addErrorClass]="addErrorClass(tyreItem.controls.manufacturer)"
                                          [params]="manufacturerParams"
                                          (postApiResponse)="getNewManufacturer($event, ii)"
                                          (addValueToList)="addNewManufacturer($event)"
                                          [selectedOption]="initialValues.manufacturer[ii]">
                                          <select #customSelect formControlName="manufacturer" class="no-style select--modify" (change)="onMakeChange(tyreItem,ii)">
                                              <option *ngFor="let option of staticOptions?.tyreManufacturer" value="{{ option?.id }}">
                                                  {{ option?.label }}
                                              </option>
                                          </select>
                                      </material-dropdown>
                                    </div>
                                </td>
                                <td class="w-150">
                                  <div  class="select-wrap">
                                    <material-dropdown [searchable]="true" [addable]="true"
                                              [postApiUrl]="modelApi"
                                              [params]="modelParams"
                                              (postApiResponse)="getNewModel($event, ii)"
                                              (addValueToList)="addNewModel($event,tyreItem)"
                                              [addErrorClass]="addErrorClass(tyreItem.controls.tyre_model)"
                                               [selectedOption]="initialValues.model[ii]">
                                                  <select #customSelect formControlName="tyre_model" class="no-style select--modify">
                                                      <option *ngFor="let model of tyreModel[ii]" value="{{model.id}}" >
                                                          {{ model.name}}
                                                      </option>
                                                  </select>
                                      </material-dropdown>
                                  </div>
                                </td>
                                <td class="w-150">
                                  <div  class="select-wrap">
                                    <material-dropdown [searchable]="true" [addable]="false" class="dropDownWidth"
                                                  [addErrorClass]="addErrorClass(tyreItem.controls.thread_type)"
                                                  [selectedOption]="initialValues.threadType[ii]">
                                                  <select #customSelect formControlName="thread_type" class="no-style select--modify">
                                                      <option *ngFor="let option of staticOptions?.threadType" value="{{ option?.id }}">
                                                          {{ option?.label }}
                                                      </option>
                                                  </select>
                                      </material-dropdown>
                                  </div>
                                </td>
                                <td>
                                    <div class='input-wrap' [ngClass]="addErrorClass(tyreItem.controls.quantity)">
                                        <input positiveDigitNumber type="text" placeholder="1000"
                                        class="error-box"
                                        formControlName="quantity" (change)="calculateItemAmountTyre(ii);">
                                    </div>
                                </td>
                                <td class="w-150">
                                    <div class="input-wrap" [ngClass]="addErrorClass(tyreItem.controls.rate)">
                                        <input positiveThreeDigitDecimalNumber type="text" class="error-box" placeholder="1000" formControlName="rate" (change)="calculateItemAmountTyre(ii)">
                                    </div>
                                </td>
                                <td class="w-150">
                                  <div class="input-wrap">
                                      <input positiveThreeDigitDecimalNumber type="text" class="error-box" placeholder="1000"
                                          formControlName="total"
                                         readonly >
                                  </div>
                                </td>
                                    <td class="text-center">
                                    <span class="material-icons delete"
                                    (click)="removeTyresItem(ii)" *ngIf="purchaseOrderForm.controls.tyres['controls'].length !== 1">add_circle_outline</span>
                                    <span class="material-icons add"
                                    (click)="addMoreTyreItem()" *ngIf="purchaseOrderForm.controls.tyres['controls'].length -1== ii">add_circle_outline</span>
                                </td>
                            </tr>
                      </ng-container>
                    </tbody>
                </table>
            </div>
            <div class="table-footer-actions mg-top-20">
                <a class="clear-item" (click)="removeTyreeAll()">
               Clear all</a>
            </div>
        </div>
    </div>
    <div class="mg-top-30">
      <div class="row">
        <div class="col-md-6">

        </div>
        <div class="col-md-6">
           <p style="float: right; font-weight: bold;">Net Total : {{purchaseOrderForm.controls.total.value}} </p>
        </div>
      </div>
    </div>
      <div class="mg-top-30">
          <div class="row">
              <div class="col-20 col-lg-3 col-sm-6">
              </div>
              <div class="col-sm-12">
                  <div class="row">
                    <div class="col-lg-3 col-sm-6">
                      <div class="input-wrap">
                          <label for="" class="input">Approval Status</label>
                          <material-dropdown [searchable]="true" [selectedOption]="initialValues.approval" [addable]="false" class="dropDownWidth">
                              <select #customSelect formControlName="approval_status" class="no-style select--modify">
                              <option *ngFor="let  approval of approvalStatus" value="{{ approval?.id}}">
                                  {{  approval.label}}
                              </option>
                          </select>
                          </material-dropdown>
                      </div>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                      <div class="input-wrap">
                          <label for="" class="input">Approver User</label>
                          <material-dropdown [searchable]="true" [addable]="false" [selectedOption]="initialValues.approvalstatus" class="dropDownWidth">
                              <select #customSelect formControlName="approval_user" class="no-style select--modify">
                              <option *ngFor="let employee of employeeList" value="{{employee?.id}}">
                                {{ employee?.first_name }} {{ employee?.last_name }}
                              </option>
                          </select>
                          </material-dropdown>
                      </div>
                    </div>
                      <div class=" col-lg-3 col-sm-6">
                          <div class="input-wrap mb-0 pb-3">
                              <label for="" class="">Optional Comment</label>
                              <input type="text" class="no-style input--bd" placeholder="Comments" formControlName="comments">
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="form-layout__card mg-top-30">
          <file-uploader (onFileUploaded)="fileUploader($event)"
          (onFileDeleted)="fileDeleted($event)" [multiple]="true"
          [accept]="'capture=camera, image/jpeg,image/x-jpg,image/png, application/pdf'"
          [showFileName]="false" [patchFileUrls]="patchFileUrls">
          </file-uploader>
      </div>
  </div>
  <div class="mg-top-30 section-footer mg-bottom-30">
      <div class="btn-wrap mg-bottom-100">
          <button class="btn w-auto px-4" [routerLink]="[prefixUrl+'/inventory/purchase-order/list']" routerLinkActive="active">Cancel</button>
          <button class="btn btn--primary btn--default btn-mg-left btn--dropdown w-auto px-4" (click)="$event.stopPropagation();saveButton=! saveButton">
              Save<i class="material-icons">arrow_drop_down</i>
              <ul class="more-actions__menu" [ngClass]="{ 'show': saveButton}">
                  <li class="more-actions__item" type="button" (click)="saveExpense(false)" >Save & Submit</li>
                  <li class="more-actions__item" type="button" (click)="saveExpense(true)">Save as Draft</li>
              </ul>
          </button>
      </div>
  </div>
</form>
<app-add-party-popup [popDetail]="showAddPartyPopup" (closeModal)="closePartyPopup()" (partyAdded)="addPartyToOption($event)" [isVendor]="true"></app-add-party-popup>
<app-add-expense-item [expenseItemPopDetail]="showAddExpenseItemPopup" (closeModal)="closeNewSparesItemPopup()" [units]="staticOptions.itemUnits"
  (itemAdded)="addDropDownNewSapre($event)" [isSpare]="true"></app-add-expense-item>
