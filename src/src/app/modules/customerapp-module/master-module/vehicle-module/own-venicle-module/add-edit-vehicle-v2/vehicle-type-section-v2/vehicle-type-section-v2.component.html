<div class="add-screen-wrap d-flex flex-column">
    <div class="def-color px-4 py-3 layout-bg">
        <h6 class="fs-5">{{vehicleId?'Edit':'Add'}} Own Vehicle</h6>
    </div>

    <div class="info-msg" *ngIf="!canCreateVehicle">
        <p class="message-cont">Please Note: The Maximum Vehicle Limit ({{registeredVehicles}}) has been reached for the
            tenant. Please delete any unused vehicles or
            contact the team to increase the limit.</p>
    </div>
    <div class="alert alert-warning" role="alert" *ngIf="driverEligibilityMsg">
        {{driverEligibilityMsg}}
    </div>

    <div class="def-color p-4 shadow-inset-top-bottom" [ngClass]="{'disabled':vehicleId!='' || !canCreateVehicle}">
        <p class=" fw-semibold">Vehicle Category<span class="text-danger">*</span></p>
        <div class="d-flex align-items-center pt-4 gap-4 flex-wrap">
            <div class="veh-type" matRipple (click)="vehicleCatagoryChange('1')"
                [class.active]="vehicleDetailsForm.get('vehicle_category').value =='1'">
                <img src="../../../../../../../../assets/img/icons/crane-truck.svg" alt="truck image">
                <p class="text-center mt-2">Crane</p>
            </div>

            <div class="veh-type" matRipple (click)="vehicleCatagoryChange('2')"
                [class.active]="vehicleDetailsForm.get('vehicle_category').value =='2'">
                <img src="../../../../../../../../assets/img/icons/awp.svg " alt="truck image">
                <p class="text-center mt-2">AWP</p>
            </div>
            <div class="veh-type" matRipple (click)="vehicleCatagoryChange('3')"
                [class.active]="vehicleDetailsForm.get('vehicle_category').value =='3'">
                <img src="../../../../../../../../assets/img/icons/trailer-head.svg " alt="truck image">
                <p class="text-center mt-2">Trailer Head</p>
            </div>
            <div class="veh-type" matRipple (click)="vehicleCatagoryChange('0')"
                [class.active]="vehicleDetailsForm.get('vehicle_category').value =='0'">
                <img src="../../../../../../../../assets/img/icons/truck-vehicle.svg " alt="truck image">
                <p class="text-center mt-2">Others</p>
            </div>

        </div>


    </div>


    <div class=" flex-grow-1 d-flex justify-content-center align-items-center flex-column" *ngIf="!isCatagorySelected">
        <i class="bi bi-truck select-veh-truck"></i>
        <p class="select-veh-text"> Please select a vehicle category for more details</p>
    </div>

    <div *ngIf="isCatagorySelected">
        <form [formGroup]="vehicleDetailsForm">
            <div class="alert-msg" *ngIf="apiError">
                <span class="icon-wrap"></span>
                <p class="message-cont">{{ apiError }}</p>
            </div>
            <div class="row p-4 pb-0 mx-0 shadow-inset-bottom">
                <div class="col-xl-3 col-lg-4 col-sm-6 ">
                    <div class="input-wrap error" [ngClass]="addErrorClass(vehicleDetailsForm.controls.vehicle_no)">
                        <label for="" class="input--required">Vehicle No.</label>
                        <input appUpperCase type="text" class="no-style input--bd" placeholder="AAAA0000"
                            formControlName="vehicle_no" maxlength="14" value="" (change)="setDisplayNo()">
                        <app-error [controlName]="vehicleDetailsForm.controls.vehicle_no"></app-error>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4 col-sm-6 ">
                    <div class="input-wrap error" [ngClass]="addErrorClass(vehicleDetailsForm.controls.reg_number)">
                        <label for="" class="input--required">Display No.</label>
                        <input appUpperCase type="text" class="no-style input--bd" placeholder="AAAA0000"
                            formControlName="reg_number" maxlength="14" value="">
                        <span *ngIf="regError" class="error-reg">{{regError}}</span>
                        <app-error [controlName]="vehicleDetailsForm.controls.reg_number"></app-error>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-4 col-sm-6">
                    <div class="input-wrap error" [ngClass]="addErrorClass(vehicleDetailsForm.controls.vehicle_type)">
                        <label for="" class="input--required">Specification</label>
                        <material-dropdown [searchable]="true" [selectedOption]="initialValues.vehicle_type"
                            [addable]="true" class="dropDownWidth" [postApiUrl]="vehicleApi" [params]="addVehicle"
                            (postApiResponse)="getNewSpecifications($event)"
                            (addValueToList)="addNewSpecifications($event)">
                            <select #customSelect formControlName="vehicle_type" class="no-style select--modify"
                                (change)="vehicleSpecificationChange()">
                                <option *ngFor="let option of vechileTypeList" value="{{ option?.id }}">
                                    {{ option?.specification }}
                                </option>
                            </select>
                        </material-dropdown>
                        <app-error [controlName]="vehicleDetailsForm.controls.vehicle_type"></app-error>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-4 col-sm-6">
                    <div class="input-wrap m-0">
                        <label for="" class="input--required">Vehicle (Brand and Model)</label>
                    </div>
                    <ng-container formGroupName="brand">
                        <div class="row">
                            <div class="col-6" [ngClass]="{'disable':!vehicleDetailsForm.controls.vehicle_type.value}">
                                <div class="input-wrap"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.brand.get('make'))">
                                    <material-dropdown [searchable]="true" [selectedOption]="initialValues.make"
                                        [addable]="true" class="dropDownWidth"
                                        [disabled]="!vehicleDetailsForm.controls.vehicle_type.value"
                                        [postApiUrl]="vehicleMakeUrl" [params]="vehicleMakeParam"
                                        (postApiResponse)="getNewVehicleMake($event)"
                                        (addValueToList)="addNewVehicleMake($event)">
                                        <select #customSelect formControlName="make" class="no-style select--modify"
                                            (change)="onMakeSelected($event)">
                                            <option *ngFor="let option of vehicleMake" value="{{ option.id }}">
                                                {{ option.make_name }}
                                            </option>
                                        </select>
                                    </material-dropdown>
                                    <app-error
                                        [controlName]="vehicleDetailsForm.controls.brand.get('make')"></app-error>
                                </div>
                            </div>
                            <div class="col-6"
                                [ngClass]="{'disable':!vehicleDetailsForm.controls.brand.get('make').value}">
                                <div class="input-wrap"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.brand.get('model'))">
                                    <material-dropdown [disabled]="!vehicleDetailsForm.controls.brand.get('make').value"
                                        [selectedOption]="initialValues.model" [searchable]="true" [addable]="true"
                                        class="dropDownWidth" [addBlank]="false" [postApiUrl]="vehicleModelUrl"
                                        [params]="vehicleModelParam" (postApiResponse)="getNewVehicleModel($event)"
                                        (addValueToList)="addNewVehicleModel($event)">
                                        <select #customSelect formControlName="model" class="no-style select--modify">
                                            <option *ngFor="let option of vehicleModel" value="{{ option.id }}">
                                                {{ option.model_name }}
                                            </option>
                                        </select>
                                    </material-dropdown>
                                    <app-error [controlName]="vehicleDetailsForm.controls.brand.get('model')"></app-error>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                </div>

                <div class="col-xl-3 col-lg-4 col-sm-6">
                    <div class="input-wrap">
                        <label for="">Operator</label>
                        <app-multi-driver-select (selectedDriverList)="selectedDriverList($event)" [driverList]="driverList" [driverControl]="vehicleDetailsForm.controls.employees_assigned"></app-multi-driver-select>
                    </div>
                </div>
            </div>
            <div class="form-layout__card def-color " *ngIf="isEmi">
                <div>
                    <button class="add-del-toggle px-3 py-3 " type="button" (click)="vehicleEmi = !vehicleEmi;">
                        <span *ngIf="!vehicleEmi"><i class="bi bi-caret-right-fill "></i></span>
                        <span *ngIf="vehicleEmi"><i class="bi bi-caret-down-fill "></i></span>
                        <span class="ms-3">EMI Details</span>
                    </button>
                </div>
                <div action="" class="form-body p-3 pb-0" *ngIf="vehicleEmi">
                    <div class="row mx-0">
                        <div class="col-xl-3 col-lg-4 col-sm-6">
                            <div class="input-wrap">
                                <label for="">EMI Status</label>
                                <material-dropdown [selectedOption]="initialValues.emiStatus" [searchable]="true"
                                    class="dropDownWidth">
                                    <select #customSelect formControlName="emi_status" class="no-style select--modify"
                                        (change)="onchnageEmiStatus()">
                                        <option *ngFor="let option of emiStatus" value="{{ option.value }}">
                                            {{ option.label }}
                                        </option>
                                    </select>
                                </material-dropdown>
                            </div>
                        </div>
                        <ng-container *ngIf="vehicleDetailsForm.controls.emi_status.value=='0'">
                            <div class="col-xl-3 col-lg-4 col-sm-6">
                                <div class="input-wrap error error--type-1"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.emi_last_date)">
                                    <label for="" class="input--required">Last EMI Date</label>
                                    <mat-form-field class="width--100">
                                        <input matInput placeholder="DD/MM/YYYY" readonly
                                            [matDatepicker]="emi_last_date" (focus)="emi_last_date.open()"
                                            formControlName="emi_last_date">
                                        <mat-datepicker-toggle matSuffix [for]="emi_last_date"></mat-datepicker-toggle>
                                        <mat-datepicker #emi_last_date></mat-datepicker>
                                    </mat-form-field>
                                    <app-error [controlName]="vehicleDetailsForm.controls.emi_last_date"></app-error>
                                </div>
                            </div>


                        </ng-container>

                        <ng-container *ngIf="vehicleDetailsForm.controls.emi_status.value=='0'">
                            <div class="col-xl-3 col-lg-4 col-sm-6">
                                <mat-checkbox color="primary" class="def-color mt-3 fw-semibold fs-13px" formControlName="emi_track" (change)="onchangeEmiTrack()">Do you want Alerts for EMI dates?</mat-checkbox>
                            </div>
                        </ng-container>
                        <ng-container *ngIf="vehicleDetailsForm.controls.emi_track.value==true">

                            <div class="col-xl-3 col-lg-4 col-sm-6">
                                <div class="input-wrap error error--type-1"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.emi_start_date)">
                                    <label for="" class="input--required">First EMI Payment Date</label>
                                    <mat-form-field class="width--100">
                                        <input matInput placeholder="DD/MM/YYYY" [matDatepicker]="emi_start_date"
                                            readonly (focus)="emi_start_date.open()" formControlName="emi_start_date"
                                            (dateChange)="emiPaymentDateChange()">
                                        <mat-datepicker-toggle matSuffix [for]="emi_start_date"></mat-datepicker-toggle>
                                        <mat-datepicker #emi_start_date></mat-datepicker>
                                    </mat-form-field>
                                    <app-error [controlName]="vehicleDetailsForm.controls.emi_start_date"></app-error>
                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-4 col-sm-6">
                                <div class="input-wrap error"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.emi_amount)">
                                    <label for="" class="input--required">EMI Amount</label>
                                    <input type="text" positiveThreeDigitDecimalNumber class="no-style input--bd"
                                        placeholder="Enter EMI Amount" formControlName="emi_amount" value="">
                                    <app-error [controlName]="vehicleDetailsForm.controls.emi_amount"></app-error>

                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-4 col-sm-6">
                                <div class="input-wrap error"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.emi_reminder_frequency)">
                                    <label for="" class="input--required">Payment Frequency</label>
                                    <material-dropdown [selectedOption]="initialValues.emi_reminder_frequency"
                                        [searchable]="true" class="dropDownWidth">
                                        <select #customSelect formControlName="emi_reminder_frequency"
                                            class="no-style select--modify">
                                            <option *ngFor="let option of EMIRemainderFrequency"
                                                value="{{ option.value }}">
                                                {{ option.label }}
                                            </option>
                                        </select>
                                    </material-dropdown>
                                    <app-error
                                        [controlName]="vehicleDetailsForm.controls.emi_reminder_frequency"></app-error>
                                </div>
                            </div>



                        </ng-container>

                    </div>

                    <div class="row mx-0">
                        <div class="col-lg-12">
                            <p class="fw-semibold fs-6 mb-4"
                                *ngIf="vehicleDetailsForm.controls.emi_status.value=='0'||vehicleDetailsForm.controls.emi_status.value=='1'">
                                Upload</p>
                            <div class="d-flex gap-3 flex-wrap mx-0 pb-4"
                                *ngIf="vehicleDetailsForm.controls.emi_status.value=='0'||vehicleDetailsForm.controls.emi_status.value=='1'">
                                <file-uploader-v2 (onFileUploaded)="fileUploader($event)"
                                    [uploaderId]="'emi-doc-'"></file-uploader-v2>
                                <div *ngFor="let document of vehicleDetailsForm.controls.emi_documents.value">
                                    <app-file-delete-view [showInlineEdit]="false" [fileData]="document"
                                        (fileDeleted)="fileDeleted($event)"></app-file-delete-view>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="border-top" *ngIf="vehicleDetailsForm.get('vehicle_category').value==3">
                <button class="add-del-toggle toggle px-3 py-3  " type="button"
                    (click)="showAssignAssetSectioon = !showAssignAssetSectioon;">
                    <span *ngIf="!showAssignAssetSectioon"><i class="bi bi-caret-right-fill "></i></span>
                    <span *ngIf="showAssignAssetSectioon"><i class="bi bi-caret-down-fill "></i></span>
                    <span class="ms-3">Assign Asset</span>
                </button>

                <ng-container *ngIf="showAssignAssetSectioon">
                    <div class="def-color p-4 pb-0 ">
                        <p class=" fw-semibold">Do you want to assign a particular asset category to this trailer head ?
                        </p>
                        <div class="pt-4 row mx-0 g-3">
                            <ng-container *ngFor="let data of assetTypeSelection;let i = index">
                                <div class="col-lg-3 col-md-6">
                                    <div class="asset-type h-100 specification-multi-select-wrap"
                                        (click)="assetTypeSelected(i,data.index,false)"
                                        [class.active]="data.isSelected">
                                        <span class="material-icons def-color check-icon" *ngIf="!data.isSelected">
                                            radio_button_unchecked
                                        </span>
                                        <span class="material-icons primary-brand-text check-icon"
                                            *ngIf="data.isSelected">
                                            check_circle
                                        </span>
                                        <img src="{{data.image}}" alt="truck image">
                                        <p class="text-center my-2 fw-semibold fw-12px"> {{data.asset_type}}</p>


                                        <div (click)="data.isSelected ? $event.stopPropagation() : null">
                                            <ng-multiselect-dropdown class="multi-dropdown"
                                                [ngClass]="{'disabled': !data.isSelected}"
                                                [ngModelOptions]="{standalone: true}"
                                                [placeholder]=" 'Select your specification '"
                                                [settings]="dropdownSettings" [data]="data.specificationList"
                                                [(ngModel)]="data.specification"
                                                (ngModelChange)="onModelChange($event)">
                                            </ng-multiselect-dropdown>
                                        </div>

                                        <span *ngIf="data.errorMsg.length >0"
                                            class="text-danger">{{data.errorMsg}}</span>


                                    </div>
                                </div>
                            </ng-container>

                        </div>

                        <div class="row mt-2 mx-0 g-3">
                            <div class="col-xl-3 col-lg-3 col-md-3 col-6">
                                <div class="input-wrap error dropdownArrow"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.asset_1)">
                                    <label for="">Asset No.1 </label>
                                    <material-dropdown [searchable]="true" [addable]="false" [addBlank]="true"
                                        [selectedOption]="initialValues.assetOne">
                                        <select #customSelect formControlName="asset_1" class="no-style select--modify"
                                            (change)="assetOneSelected()">
                                            <ng-container *ngFor="let option of assetData">
                                                <option
                                                    *ngIf="vehicleDetailsForm.get('asset_2').value !== option?.id && vehicleDetailsForm.get('asset_3').value !== option?.id"
                                                    value="{{ option?.id }}">
                                                    {{ option?.display_no }}
                                                </option>
                                            </ng-container>
                                        </select>
                                    </material-dropdown>
                                    <app-error [controlName]="vehicleDetailsForm.controls.asset_1"></app-error>
                                    <p class="font-small-blue" *ngIf="asset1Specification">&nbsp;{{asset1Specification}}
                                    </p>
                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-3 col-md-3 col-6">
                                <div class="input-wrap error dropdownArrow"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.asset_2)">
                                    <label for="">Asset No.2 </label>
                                    <material-dropdown [searchable]="true" [addable]="false" [addBlank]="true"
                                        [selectedOption]="initialValues.assetTwo">
                                        <select #customSelect formControlName="asset_2" class="no-style select--modify"
                                            (change)="assetTwoSelected()">
                                            <ng-container *ngFor="let option of assetData">
                                                <option
                                                    *ngIf="vehicleDetailsForm.get('asset_1').value !== option?.id && vehicleDetailsForm.get('asset_3').value !== option?.id"
                                                    value="{{ option?.id }}">
                                                    {{ option?.display_no }}
                                                </option>
                                            </ng-container>
                                        </select>
                                    </material-dropdown>
                                    <app-error [controlName]="vehicleDetailsForm.controls.asset_2"></app-error>
                                    <p class="font-small-blue" *ngIf="asset2Specification">&nbsp;{{asset2Specification}}
                                    </p>

                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-3 col-md-3 col-6">
                                <div class="input-wrap error dropdownArrow"
                                    [ngClass]="addErrorClass(vehicleDetailsForm.controls.asset_3)">
                                    <label for="">Asset No.3 </label>
                                    <material-dropdown [searchable]="true" [addable]="false" [addBlank]="true"
                                        [selectedOption]="initialValues.assetThree">
                                        <select #customSelect formControlName="asset_3" class="no-style select--modify"
                                            (change)="assetThreeSelected()">
                                            <ng-container *ngFor="let option of assetData">
                                                <option
                                                    *ngIf="vehicleDetailsForm.get('asset_1').value !== option?.id && vehicleDetailsForm.get('asset_2').value !== option?.id"
                                                    value="{{ option?.id }}">
                                                    {{ option?.display_no }}
                                                </option>
                                            </ng-container>
                                        </select>
                                    </material-dropdown>
                                    <app-error [controlName]="vehicleDetailsForm.controls.asset_3"></app-error>
                                    <p class="font-small-blue" *ngIf="asset3Specification">&nbsp;{{asset3Specification}}
                                    </p>

                                </div>
                            </div>

                        </div>


                    </div>

                </ng-container>
            </div>

            <div class="gb-tab-wrapper">
                <mat-tab-group mat-stretch-tabs="false" [selectedIndex]="selectedTabIndex" animationDuration="0ms"
                    mat-align-tabs="start" #tabGroup>
                    <mat-tab label="Vehicle Details">
                        <ng-template mat-tab-label>
                            <span>Vehicle Details</span>
                        </ng-template>
                        <app-vehicle-details-v2 [vehicleCatagory]="vehicleCatagory"
                            [vehicleDetailsForm]="this.vehicleDetailsForm" [documentEditList]="ownVehicleSubDetails">
                        </app-vehicle-details-v2>
                    </mat-tab>
                    <mat-tab label="Certificates">
                        <ng-template mat-tab-label>
                            <span class="fw-semibold "
                                [ngClass]="{taberror:vehicleDetailsForm.get('documents').invalid && isFormSubmitted}">Certificates</span>
                        </ng-template>
                        <app-vehicle-document-section-v2 [vehicleDetailsForm]="this.vehicleDetailsForm"
                            [isFormSubmitted]="isFormSubmitted" [isFormValid]="isFormValid"
                            [newPartyDetails]="newPartyCertificatesDetails" (addNewParty)="addNewParty($event)"
                            [vehicleCatagory]="vehicleCatagory"
                            [documentEditList]="certificate"></app-vehicle-document-section-v2>
                    </mat-tab>
                    <mat-tab label="Permit">
                        <ng-template mat-tab-label>
                          <span class="fw-semibold " [ngClass]="{taberror:vehicleDetailsForm.get('permits').invalid && isFormSubmitted}" >Permit</span>
                        </ng-template>
                        <app-permit-section-own-vehicle [isFormSubmitted]="isFormSubmitted" [vehicleDetailsForm]="this.vehicleDetailsForm" [isFormValid]="isFormValid" [newPartyDetails]="newPartyPermitDetails" (addNewParty)="addNewParty($event)" [vehicleCatagory]="vehicleCatagory"  [permitEditList]="vehiclePermits"></app-permit-section-own-vehicle>
                        </mat-tab>
                    <mat-tab label="Attachments">
                        <ng-template mat-tab-label>
                            <span class="fw-semibold "
                                [ngClass]="{taberror:vehicleDetailsForm.get('subassets').invalid && isFormSubmitted}">Attachments</span>
                        </ng-template>
                        <app-sub-assets-own-vehicle [isFormSubmitted]="isFormSubmitted"
                            [vehicleCatagory]="vehicleCatagory" [isFormValid]="isFormValid"
                            [vehicleDetailsForm]="this.vehicleDetailsForm" [documentEditList]="subAssets">

                        </app-sub-assets-own-vehicle>
                    </mat-tab>
                    <mat-tab label="Tyre Master">
                        <ng-template mat-tab-label>
                            <span>Tyre Master</span>
                        </ng-template>
                        <app-tyre-master-tyre-master [vehicleDetailsForm]="this.vehicleDetailsForm"
                            [editTyreDetails]="tyreDetails"></app-tyre-master-tyre-master>
                    </mat-tab>
                </mat-tab-group>
            </div>
        </form>

    </div>

</div>



<div class="footer-bg p-2 px-4 custom-footer-bg d-flex justify-content-end" *ngIf="canCreateVehicle">
    <button class="btn btn--sm me-2" type="button"  [routerLink]="[prefixUrl+'/onboarding/vehicle/own/vehicle-list']">Cancel</button>
    <button class="btn btn--primary btn--sm" [disabled]="!isCatagorySelected" (click)="submitForm()">{{vehicleId?'Update':'Save'}}</button>
</div>
<app-add-party-popup *ngIf="showAddPartyPopup.status" [popDetail]="showAddPartyPopup" (closeModal)="closePartyPopup()"
    (partyAdded)="addPartyToOption($event)" [isVendor]="true"></app-add-party-popup>